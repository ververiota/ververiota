module.exports.config = {
	name: "spamban",
	version: "1.0.0",
	hasPermssion: 0, 
	credits: "NTKhang",
	description: "tá»± Ä‘á»™ng cáº¥m ngÆ°á»i dÃ¹ng náº¿u spam bot (random image)",
	commandCategory: "KhÃ´ng cáº§n dáº¥u lá»‡nh",
	usages: "x",
	cooldowns: 5
};

module.exports.run = ({api, event}) => {
  return api.sendMessage("báº¡n sáº½ bá»‹ ban náº¿u spam bot", event.threadID, event.messageID);
};
module.exports.handleEvent = async ({ Users, api, event})=> {
		const axios = require('axios');
	const request = require('request');
	const fs = require("fs"); 
	const moment = require("moment-timezone"); 
  let { senderID, messageID, threadID } = event;
  const threadInfo = await api.getThreadInfo(event.threadID)
    var threadName = threadInfo.threadName||"TÃªn khÃ´ng tá»“n táº¡i";
  var time = moment.tz("Asia/Ho_Chi_minh").format("DD/MM/YYYY HH:mm:ss");
  const so_lan_spam = 5; // sá»‘ láº§n spam, vÆ°á»£t quÃ¡ sáº½ bá»‹ ban
  const thoi_gian_spam = 60000; // 60000 millisecond (1 phÃºt)
  const unbanAfter = 3600000; // 600000 millisecond (10 phÃºt) 
  if (!global.client.autoban) global.client.autoban = {};
  if (!global.client.autoban[senderID]) {
    global.client.autoban[senderID] = {
      timeStart: Date.now(),
      number: 0
    }
  };
  
  const threadSetting = global.data.threadData.get(parseInt(threadID)) || {};
	const prefix = threadSetting.PREFIX || global.config.PREFIX;
	if (!event.body || event.body.indexOf(prefix) != 0) return; 
	let dataUser = await Users.getData(senderID) || {};
	let data = dataUser.data || {};
	
	if ((global.client.autoban[senderID].timeStart + thoi_gian_spam) <= Date.now()) {
	  global.client.autoban[senderID] = {
	    timeStart: Date.now(),
	    number: 0
	  }
	}
	else {
	  global.client.autoban[senderID].number++;
	  if (global.client.autoban[senderID].number >= so_lan_spam) {
	    const moment = require("moment-timezone");
			if (data && data.banned == true) return;
			data.banned = true;
			data.reason = `â€¢ ğ—¦ğ—½ğ—®ğ—º ğ—•ğ—¼ğ˜ ${so_lan_spam} ğ—¹ğ—®Ì‚Ì€ğ—»/${thoi_gian_spam/60000} ğ—½ğ—µğ˜‚Ìğ˜\nâ€¢ ğ—¦ğ—²Ìƒ ğ˜ğ˜‚Ì›Ì£ ğ—±ğ—¼Ì£Ì‚ğ—»ğ—´ ğ—´ğ—¼Ì›Ìƒ ğ—¯ğ—®ğ—» ğ˜€ğ—®ğ˜‚ ğŸ²ğŸ¬ ğ—½ğ—µğ˜‚Ìğ˜ ğ—»ğ˜‚Ì›Ìƒğ—®`;
			data.autoban = {
			  timeStart: Date.now(),
			  unbanAfter
			};
			data.dateAdded = time;
			await Users.setData(senderID, { data });
			global.data.userBanned.set(senderID, { reason: data.reason, dateAdded: data.dateAdded });
			global.client.autoban[senderID] = {
	      timeStart: Date.now(),
	      number: 0
	    };
axios.get('https://jrt-api.j-jrt-official.repl.co/gai').then(res => {
	let ext = res.data.data.substring(res.data.data.lastIndexOf(".") + 1);

      var callback = function () {
  		api.sendMessage({
  		  body: "â€¢ ğ—§ğ—²Ì‚ğ—»: " + dataUser.name + "\nâ€¢ ğ—œğ——: " + senderID + `\nâ£ ğ—•ğ—¶Ì£ ğ—°ğ—®Ì‚Ìğ—º ğ˜€ğ˜‚Ì›Ì‰ ğ—±ğ˜‚Ì£ğ—»ğ—´ ğ—•ğ—¼ğ˜ ${unbanAfter/60000} ğ—½ğ—µğ˜‚Ìğ˜ ğ˜ƒğ—¼Ì›Ìğ—¶ ğ—¹ğ—¶Ì ğ—±ğ—¼ ğ˜€ğ—½ğ—®ğ—º ğ—•ğ—¼ğ˜ 5 ğ—¹ğ—®Ì‚Ì€ğ—»/ğ—½ğ—µğ˜‚Ìğ˜\nâ£ ğ—›ğ—®Ìƒğ˜† ğ—»ğ—¼Ìğ—¶ ğ—¹ğ—¼Ì›Ì€ğ—¶ ğ˜ğ—¿ğ—®Ì†ğ—» ğ˜ğ—¿ğ—¼Ì‚Ìğ—¶ ğ—±ğ—²Ì‚Ì‰ ğ—•ğ—¼ğ˜ ğ—°ğ—¼Ì ğ˜ğ—µğ—²Ì‚Ì‰ ğ—´ğ—¼Ì›Ìƒ ğ—¯ğ—®ğ—» ğ˜€ğ—®ğ˜‚ ${Math.floor(unbanAfter/60000)} ğ—½ğ—µğ˜‚Ìğ˜ ğ—»ğ˜‚Ì›Ìƒğ—®\nğ—§ğ—µğ—¼Ì›Ì€ğ—¶ ğ—´ğ—¶ğ—®ğ—»: ${time}`,
						attachment: fs.createReadStream(__dirname + `/cache/spamban.${ext}`)
					}, event.threadID, () => {
      
  		    setTimeout(async function() {
  		      delete data.autoban;
      	    data.banned = false;
      			data.reason = null;
      			data.dateAdded = null;
      			await Users.setData(senderID, { data });
      			global.data.userBanned.delete(senderID);
      				api.sendMessage("â£ ğ——ğ—®Ìƒ ğ˜ğ˜‚Ì›Ì£ ğ—±ğ—¼Ì£Ì‚ğ—»ğ—´ ğ—´ğ—¼Ì›Ìƒ ğ—¯ğ—®ğ—» ğ˜ğ—µğ—®Ì€ğ—»ğ—µ ğ—°ğ—¼Ì‚ğ—»ğ—´ ğ—°ğ—µğ—¼ " + dataUser.name + "\nâ£ ğ—•ğ—¶Ì£ ğ—¯ğ—®ğ—» ğ˜ƒğ—®Ì€ğ—¼ ğ—¹ğ˜‚Ìğ—° " + time +  ` ğ—¸ğ—µğ—¼Ì‚ğ—»ğ—´ ğ˜€ğ—½ğ—®ğ—º ğ—»ğ˜‚Ì›Ìƒğ—® ğ—»ğ—µğ—²Ì!!!`, threadID); //mod by toÃ n
 			  }, unbanAfter);
  	fs.unlinkSync(__dirname + `/cache/spamban.${ext}`), event.messageID
				 	  });

  }
  request(res.data.data).pipe(fs.createWriteStream(__dirname + `/cache/spamban.${ext}`)).on("close", callback);
			})

        for (let idAdmin of global.config.ADMINBOT) {
  		  api.sendMessage(`â—†â”â”ğ—•ğ—¢ğ—§ ğ—§ğ—›ğ—¢Ì‚ğ—¡ğ—š ğ—•ğ—”Ìğ—¢â”â”â—†\n\nâ£ ğ—¡ğ—´ğ˜‚Ì›ğ—¼Ì›Ì€ğ—¶ ğ—±ğ˜‚Ì€ğ—»ğ—´ ğ—¦ğ—½ğ—®ğ—º ${so_lan_spam} ğ—¹ğ—®Ì‚Ì€ğ—»/ğ—½ğ—µğ˜‚Ìğ˜\nâ€¢ ğ—§ğ—²Ì‚ğ—»: ${dataUser.name} \nâ€¢ ğ—œğ——: ${senderID}\nâ€¢ ğ—§ğ—²Ì‚ğ—» ğ—»ğ—µğ—¼Ìğ—º: ${threadName} \nâ€¢ ğ—œğ—— ğ—»ğ—µğ—¼Ìğ—º: ${threadID}\nâ€¢ ğ—§ğ—µğ—¼Ì›Ì€ğ—¶ ğ—´ğ—¶ğ—®ğ—»: ${time}` ,idAdmin);
		  };
	  }
	}
};

//gá»­i all admin
// FIX ERROR